<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel | Stock & Orders</title>
<!-- ‚úÖ Load utility functions -->
<script src="./utils.js"></script>
<style>
:root{--primary:#2563eb;--bg:#f8fafc;--card:#fff;--text:#111827}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:var(--bg);color:var(--text)}

/* ===== Navbar ===== */
.navbar{position:sticky;top:0;z-index:999;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#111827;color:#fff}
.navbar h1{font-size:18px;margin:0}
.navbar .menu{display:flex;gap:10px}
.navbar button{background:transparent;border:none;color:#e5e7eb;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:14px}
.navbar button.active,.navbar button:hover{background:var(--primary);color:#fff}
.navbar .logout{background:#dc2626;color:#fff}
.navbar .logout:hover{background:#b91c1c}
.navbar button.active,.navbar button:hover{background:var(--primary);color:#fff}

.section{display:none;padding:20px}
.section.active{display:block}

iframe{width:100%;height:calc(100vh - 80px);border:none;border-radius:16px;background:#fff}
</style>
</head>
<body>
<!-- üîê SUPABASE LOGIN -->
<div id="loginPage" style="position:fixed;inset:0;background:#f1f5f9;display:flex;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;padding:24px;border-radius:14px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h3 style="margin-top:0">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <input id="loginEmail" type="email" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px" />
    <input id="loginPass" type="password" placeholder="Password" style="width:100%;padding:10px;margin-bottom:12px" />
    <button id="loginBtn" style="width:100%;padding:10px;background:#2563eb;color:#fff;border:none;border-radius:8px">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <p id="loginErr" style="color:#dc2626;font-size:13px;display:none;margin-top:8px"></p>
  </div>
</div>


<!-- ===== Navigation ===== -->
<div class="navbar">
  <h1>üß† Admin Control</h1>
 <div class="menu">
    <button id="tabStock" class="active">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button id="tabOrders">üßæ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="tabSales">üí∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button> 
    <button id="logoutBtn" class="logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>
</div>
</div>

<div id="salesSection" class="section">
  

 

<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<style>
:root{
  --radius:16px;
  --bg:#f8fafc;--card:#ffffff;--primary:#2563eb;--primary-soft:#dbeafe;
  --success:#16a34a;--warn:#f59e0b;--border:#e5e7eb;--text:#0f172a;--muted:#64748b
}
body{font-family:Inter,system-ui;background:linear-gradient(180deg,#f8fafc,#eef2f7);padding:24px;color:var(--text)}
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:18px}
.sum-card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 10px 26px rgba(15,23,42,.08)}
.sum-card span{color:var(--muted);font-size:13px}
.sum-card b{display:block;margin-top:6px;font-size:22px}
.sum-card .profit{color:var(--success)}
body{font-family:Inter,system-ui;background:linear-gradient(180deg,#f8fafc,#eef2f7);padding:24px;color:var(--text)}
.container{max-width:1400px;margin:auto}

/* Header */
h2{margin:0 0 14px;font-size:22px;font-weight:700}

/* Tabs */
.tabs{display:flex;gap:6px;background:#f1f5f9;padding:6px;border-radius:999px}
.tab{padding:10px 22px;border-radius:999px;cursor:pointer;font-weight:600;color:var(--muted);background:transparent;transition:.2s}
.tab.active{background:var(--primary);color:#fff;box-shadow:0 6px 16px rgba(37,99,235,.35)}
.tab:not(.active):hover{background:var(--primary-soft)}

/* Search */
.search{padding:12px 20px;border:1px solid var(--border);border-radius:999px;min-width:300px;outline:none}
.search:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(37,99,235,.15)}

/* Card */
.card{background:var(--card);border-radius:20px;padding:16px;box-shadow:0 12px 30px rgba(15,23,42,.08)}

/* Table */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:1100px}
th,td{padding:14px;border-bottom:1px solid #f1f5f9;font-size:14px;text-align:left;white-space:nowrap}
th{background:#f8fafc;font-weight:600;position:sticky;top:0;z-index:2}
tr:hover td{background:#f9fafb}

/* Buttons */
.btn-view{padding:6px 14px;border-radius:999px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-size:12px;font-weight:600}
.btn-view:hover{opacity:.9}

/* Badges */
.badge{padding:4px 12px;border-radius:999px;font-size:12px;font-weight:500}
.badge.success{background:#dcfce7;color:#166534}
.badge.warn{background:#fef9c3;color:#854d0e}

/* Money */
.money{font-weight:700}
.money.success{color:var(--success)}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:50;padding:20px}
.modal{background:#fff;border-radius:24px;max-width:860px;width:100%;padding:24px;box-shadow:0 30px 60px rgba(0,0,0,.35);animation:pop .25s ease}
@keyframes pop{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-title{font-size:18px;font-weight:700}
.modal-close{cursor:pointer;font-size:20px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.modal img{width:100%;max-height:520px;object-fit:contain;border-radius:16px;background:#f1f5f9}
</style>



</head>



<body>
<div class="container">
  <h2>üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>

  <!-- Summary -->
  <div class="summary">
    <div class="sum-card"><span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><b id="sumTotal">-</b></div>
    <div class="sum-card"><span>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</span><b id="sumProfit" class="profit">-</b></div>
    <div class="sum-card"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span><b id="sumCount">-</b></div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px">
    <div class="tabs">
      <div class="tab active" id="tabStore">üõí ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div>
      <div class="tab" id="tabOnline">üåê ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
    </div>
    <input id="jedSearchSalesInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
  </div>

  

  <div class="card">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Supabase CDN (NO MODULE) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ================= App Config =================
const CONFIG = {
  supabaseUrl: localStorage.getItem('supabase_url') || 'https://dfeaeyywbaywrvnudgvu.supabase.co',
  supabaseKey: localStorage.getItem('supabase_key') || 'sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd',
  appName: 'Admin Control Stock System',
  version: '1.0.0'
};

// ================= Supabase =================
if(!window.supabaseClient){
  try {
    window.supabaseClient = supabase.createClient(
      CONFIG.supabaseUrl,
      CONFIG.supabaseKey
    );
  } catch(err) {
    console.error('‚ùå Failed to initialize Supabase:', err);
    alert('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
  }
}
const db = window.supabaseClient;

// ================= DOM =================
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const tabStore = document.getElementById('tabStore');
let currentRows = [];
const tabOnline = document.getElementById('tabOnline');
const jedSearchSalesInput = document.getElementById('jedSearchSalesInput');

// ================= Utils =================
async function viewProduct(productId){
  if(!productId){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }
  const backdrop = document.getElementById('modalBackdrop');
  const body = document.getElementById('modalBody');
  body.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
  backdrop.style.display='flex';

  const {data: p, error} = await db
    .from('products')
    .select('*')
    .eq('id', productId)
    .single();

  if(error || !p){ body.innerHTML='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'; return; }

  const IMAGE_BASE='https://dfeaeyywbaywrvnudgvu.supabase.co/storage/v1/object/public/product-images/';
  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  let images = [];
  if (Array.isArray(p.image_urls) && p.image_urls.length) {
    images = p.image_urls;
  } else if (typeof p.image_urls === 'string') {
    try {
      const arr = JSON.parse(p.image_urls);
      if (Array.isArray(arr)) images = arr;
    } catch(e){}
  }
  if (!images.length && p.image_url) images = [p.image_url];
  const fullImages = images.map(raw => raw.startsWith('http') ? raw : IMAGE_BASE + raw);

  body.innerHTML = `
    <div class="modal-grid">
      <div>
        <img id="mainProductImg" src="${fullImages[0] || 'https://via.placeholder.com/600'}" onerror="this.src='https://via.placeholder.com/600'">
        <div style="display:flex;gap:10px;margin-top:12px;overflow-x:auto;padding-bottom:6px;max-width:100%">
          ${fullImages.map((img,i)=>`<img src="${img}" style="width:80px;height:80px;object-fit:cover;border-radius:12px;cursor:pointer;border:2px solid ${i===0?'#2563eb':'#e5e7eb'}" onclick="document.getElementById('mainProductImg').src='${img}';this.parentNode.querySelectorAll('img').forEach(t=>t.style.border='2px solid #e5e7eb');this.style.border='2px solid #2563eb'">`).join('')}
        </div>
      </div>
      <div>
        <ul class="detail-list">
          <li><span>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><b>${p.name}</b></li>
          <li><span>‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô</span><b>${(p.brand_caption||'-').split('-').map(s=>'- '+s.trim()).join('<br>')}</b></li>
          <li><span>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</span><b>${p.brand||'-'}</b></li>
          <li><span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><b>${p.category||'-'}</b></li>
          <li><span>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</span><b>${p.inbound_bill||'-'}</b></li>
          <li><span>‡∏™‡∏≤‡∏Ç‡∏≤</span><b>${p.branch_address||'-'}</b></li>
          <li><span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</span><b>${p.cost||0}</b></li>
          <li><span>‡∏£‡∏≤‡∏Ñ‡∏≤</span><b>${p.price||0}</b></li>
        </ul>
      </div>
    </div>`;
}
function closeModal(){document.getElementById('modalBackdrop').style.display='none'}

// ================= Summary =================
function updateSummary(rows){
  const start = new Date();
  start.setHours(0,0,0,0);
  let total = 0;
  let profit = 0;
  let count = 0;

  rows.forEach(r=>{
    if(!r.created_at) return;
    const d = new Date(r.created_at);
    if(d >= start){
      total += Number(r.total||0);
      profit += Number(r.profit||r.commission||0);
      count++;
    }
  });

  document.getElementById('sumTotal').textContent = total.toLocaleString('th-TH');
  document.getElementById('sumProfit').textContent = profit.toLocaleString('th-TH');
  document.getElementById('sumCount').textContent = count.toLocaleString('th-TH');
}

// ================= Render =================
function renderRows(rows){
  const IMAGE_BASE = 'https://dfeaeyywbaywrvnudgvu.supabase.co/storage/v1/object/public/product-images/';
  tbody.innerHTML = rows.map(r=>{
    let firstImage = null;
    if (Array.isArray(r.product?.image_urls) && r.product.image_urls.length) {
      firstImage = r.product.image_urls[0];
    } else if (typeof r.product?.image_urls === 'string') {
      try {
        const arr = JSON.parse(r.product.image_urls);
        if (Array.isArray(arr) && arr.length) firstImage = arr[0];
      } catch(e){}
    }

    const raw = firstImage || r.product?.image_url || '';
    const imgSrc = raw
      ? (raw.startsWith('http') ? raw : IMAGE_BASE + raw)
      : 'https://via.placeholder.com/48';

    return `
    <tr>
      <td>
        <img src="${imgSrc}" 
             style="width:48px;height:48px;object-fit:cover;border-radius:8px;cursor:zoom-in"
             onclick="viewProduct('${r.product_id}')"
             onerror="this.src='https://via.placeholder.com/48'">
      </td>
      <td>${r.inbound_bill || '-'}</td>
      <td>${r.product?.name || r.product_name || '-'}</td>
      <td>${r.qty || 0}</td>
      <td>${r.price || 0}</td>
      <td><b>${r.total || 0}</b></td>
      <td>${r.lost_branch || '-'}</td>
      <td>${r.branch || '-'}</td>
      <td>${r.staff || '-'}</td>
      <td>üí∞ ${r.commission ? r.commission.toFixed(2) : '0.00'}</td>
      <td>${new Date(r.created_at).toLocaleString('th-TH')}</td>
      <td><button class="btn-view" onclick="viewProduct('${r.product_id}')">‡∏î‡∏π</button></td>
    </tr>`;
  }).join('');
}

// ================= Search =================
jedSearchSalesInput.oninput = () => {
  const q = jedSearchSalesInput.value.toLowerCase();
  renderRows(currentRows.filter(r =>
    Object.values(r).some(v => String(v||'').toLowerCase().includes(q))
  ));
};

// ================= Loaders =================
async function loadStoreSales(){
  setActiveTab(tabStore);

  thead.innerHTML = `
    <tr>
      <th>‡∏£‡∏π‡∏õ</th>
      <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• (inbound)</th>
      <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
      <th>‡∏£‡∏ß‡∏°</th>
      <th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î</th>
      <th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
      <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
      <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
    </tr>`;

  const {data: sales, error} = await db
    .from('sales')
    .select('id, product_id, product_name, qty, price, total, branch, staff, created_at, commission')
    .order('created_at', { ascending: false });

  if(error){ console.error(error); alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; }

  const productIds = [...new Set((sales||[]).map(s=>s.product_id).filter(Boolean))];
  let productMap = {};

  if(productIds.length){
    const {data: products} = await db
      .from('products')
      .select('id, name, image_url, image_urls, branch_address, cost, inbound_bill')
      .in('id', productIds);
    (products||[]).forEach(p=> productMap[p.id] = p);
  }

  currentRows = (sales||[]).map(s => ({
    ...s,
    inbound_bill: productMap[s.product_id]?.inbound_bill || '-',
    product: productMap[s.product_id] || {},
    lost_branch: productMap[s.product_id]?.branch_address || '-',
    commission: Math.max(((s.price || 0) - (productMap[s.product_id]?.cost||0)) * 0.05, 0)
  }));

  renderRows(currentRows);
  updateSummary(currentRows);
}

// ================= Online =================
async function loadOnlineSales(){
  setActiveTab(tabOnline);

  thead.innerHTML = `
    <tr>
      <th>‡∏£‡∏π‡∏õ</th>
      <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
      <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
      <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
      <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
      <th>‡∏£‡∏ß‡∏°</th>
      <th>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
      <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
      <th>‡∏™‡∏•‡∏¥‡∏õ</th>
    </tr>`;

  const { data, error } = await db
    .from('sell_online')
    .select(`*, products:product_id ( branch_address, cost, image_url, image_urls )`)
    .order('created_at', { ascending: false });

  if(error){ alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); console.error(error); return; }

  currentRows = (data||[]).map(r => {
    const cost = r.products?.cost || 0;
    const qty = r.qty || 0;
    const profit = ((r.price || 0) - cost) * qty;
    return {
      ...r,
      profit,
      product: r.products || {}
    };
  });

  renderOnlineRows(currentRows);
  updateSummary(currentRows);
}

function renderOnlineRows(rows){
  const IMAGE_BASE = 'https://dfeaeyywbaywrvnudgvu.supabase.co/storage/v1/object/public/product-images/';
  tbody.innerHTML = rows.map(r=>{
    let img = r.product?.image_url || '';
    if(Array.isArray(r.product?.image_urls) && r.product.image_urls.length){
      img = r.product.image_urls[0];
    }
    const imgSrc = img ? (img.startsWith('http') ? img : IMAGE_BASE + img) : 'https://via.placeholder.com/48';

    return `
      <tr>
        <td>
          <img src="${imgSrc}" 
               style="width:48px;height:48px;object-fit:cover;border-radius:8px;cursor:zoom-in"
               onclick="viewProduct('${r.product_id}')"
               onerror="this.src='https://via.placeholder.com/48'">
        </td>
        <td>${r.product_name||'-'}</td>
        <td>${r.customer_name||'-'}</td>
        <td>${r.customer_phone||'-'}</td>
        <td>${r.customer_address||'-'}</td>
        <td>${r.qty||0}</td>
        <td>${((r.product?.cost||0)*(r.qty||0)).toLocaleString('th-TH')}</td>
        <td>${(r.price||0).toLocaleString('th-TH')}</td>
        <td><b style="color:#16a34a">${(r.profit||0).toLocaleString('th-TH')}</b></td>
        <td><b>${(r.total||0).toLocaleString('th-TH')}</b></td>
        <td>${r.payment_type||'-'}</td>
        <td>${r.status||'-'}</td>
        <td>${r.product?.branch_address||'-'}</td>
        <td>${r.branch||'-'}</td>
        <td>${r.staff_name||'-'}</td>
        <td>${r.created_at ? new Date(r.created_at).toLocaleString('th-TH'):'-'}</td>
        <td>üí∞ ${(r.commission||0).toLocaleString('th-TH')}</td>
        <td>${r.slip_url ? `<button class="btn-view" onclick="window.open('${r.slip_url}','_blank')">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>` : '-'}</td>
      </tr>`;
  }).join('');
}

function setActiveTab(active){
  [tabStore, tabOnline].forEach(t=>t.classList.remove('active'));
  active.classList.add('active');
}

// ================= Events =================
tabStore.onclick = loadStoreSales;
tabOnline.onclick = loadOnlineSales;


// ================= Init =================
loadStoreSales();
</script>
<div class="modal-backdrop" id="modalBackdrop" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      <div class="modal-close" onclick="closeModal()">‚úñ</div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>
</body>



</html>








  
  
</div>








  
<!-- ===== Sections ===== -->
<div id="stockSection" class="section active">  
   <!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Production)</title>
<style>
:root{--primary:#2563eb;--success:#16a34a;--danger:#dc2626;--warning:#f59e0b;--light:#f8fafc;--muted:#6b7280;--dark:#111827}
*{box-sizing:border-box}
body{font-family:Inter,system-ui;background:linear-gradient(180deg,#f8fafc,#eef2ff);margin:0;padding:20px;color:#111}
.container{max-width:1400px;margin:auto}
h2{display:flex;align-items:center;gap:8px;border-left:6px solid var(--primary);padding-left:12px;margin-bottom:12px}
.card{background:#fff;padding:20px;border-radius:18px;box-shadow:0 12px 32px rgba(0,0,0,.08)}
.btn{padding:8px 14px;border:none;border-radius:10px;color:#fff;cursor:pointer;font-size:13px;font-weight:600;transition:.2s}
.btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
.btn-add{background:linear-gradient(135deg,var(--success),#22c55e)}
.btn-edit{background:linear-gradient(135deg,var(--warning),#fbbf24)}
.btn-delete{background:linear-gradient(135deg,var(--danger),#ef4444)}
.badge{padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600;display:inline-block}
.badge-ok{background:#dcfce7;color:#166534}
.badge-res{background:#fee2e2;color:#991b1b}
input,textarea{padding:9px 10px;border:1px solid #e5e7eb;border-radius:10px;font-size:13px;transition:.15s;width:100%}
input::placeholder,textarea::placeholder{color:#9ca3af}
input:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}

table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:12px 10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:13px;vertical-align:top}
th{color:#374151;font-weight:600;background:#f9fafb;position:sticky;top:0;z-index:5}
tr:hover td{background:#f8fafc}
.td-caption{white-space:pre-line;line-height:1.5;color:#374151}

.img-thumb{width:48px;height:48px;object-fit:cover;border-radius:10px;background:#e5e7eb;cursor:pointer}

/* image viewer */
.image-viewer{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:2000}
.image-viewer img{max-width:90%;max-height:90%;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}

.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:1000}
.modal{background:#fff;padding:22px;border-radius:20px;width:420px;max-width:94%;box-shadow:0 20px 50px rgba(0,0,0,.25)}
.modal h3{margin-top:0;margin-bottom:10px}

.reserve-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:13px;background:#f9fafb;padding:8px 10px;border-radius:10px}

.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px;margin-top:8px}
.image-item{position:relative}
.image-item img{width:100%;height:80px;object-fit:cover;border-radius:10px}
.image-item button{position:absolute;top:6px;right:6px;border:none;background:rgba(0,0,0,.6);color:#fff;border-radius:999px;width:22px;height:22px;cursor:pointer}

.action-col{display:flex;flex-direction:column;gap:6px;align-items:stretch}
.action-col .btn{width:100%}

@media(max-width:900px){
  table{font-size:12px}
  th,td{padding:10px 6px}
  .action-col{gap:4px}
}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠ / ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / ‡∏™‡∏≤‡∏Ç‡∏≤)" style="min-width:320px" />
      <button class="btn btn-add" id="openAddProduct">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>
  </div>
  <div class="card" style="margin-bottom:16px">
  <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
  <div id="stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px"></div>
</div>
<div class="card">
  <table>
      <thead>
        <tr>
          <th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô</th><th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡∏™‡∏≤‡∏Ç‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th>‡∏ó‡∏∏‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>

<div id="imageViewer" class="image-viewer" onclick="this.style.display='none'">
  <img id="imageViewerImg" />
</div>
    </table>
  </div>
</div>

<!-- Modal ‡∏à‡∏≠‡∏á -->
<div id="modal" class="modal-backdrop"><div class="modal">
  <h3>‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
  <div id="reserveList"></div>
  <div style="display:flex;gap:6px;margin-top:10px">
    <input id="staffInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />
    <input id="qtyInput" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" />
    <button class="btn btn-add" id="addReserveBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
  </div>
  <div style="margin-top:14px;text-align:right"><button class="btn btn-delete" id="closeModalBtn">‡∏õ‡∏¥‡∏î</button></div>
</div></div>

<!-- Modal ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS) -->
<div id="posModal" class="modal-backdrop">
  <div class="modal">
    <h3>üõí ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h3>
    <div style="margin-bottom:8px"><b id="posProductName"></b></div>
    <div style="font-size:13px;color:#6b7280;margin-bottom:10px">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="posStock"></span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
    <input id="posBranch" placeholder="üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢" />
    <input id="posStaff" placeholder="üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢" />
    <input id="posQty" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢" />
    <div style="margin-top:14px;display:flex;justify-content:space-between;gap:8px">
      <button class="btn btn-delete" id="posCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-add" id="posConfirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≤‡∏¢</button>
    </div>
  </div>
</div>

<!-- Modal ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå -->
<div id="onlineModal" class="modal-backdrop">
  <div class="modal">
    <h3>üåê ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h3>
    <div style="margin-bottom:6px"><b id="onlineProductName"></b></div>

    <input id="onlineBranch" placeholder="üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢" />
    <input id="onlineStaff" placeholder="üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />

    <input id="onlineCustomerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
    <input id="onlineCustomerPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" />
    <textarea id="onlineCustomerAddress" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á"></textarea>
    <input id="onlineQty" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" />

    <label style="font-size:13px;margin-top:6px">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
    <select id="onlinePaymentType" style="width:100%;padding:9px;border-radius:10px;border:1px solid #e5e7eb">
      <option value="transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
      <option value="cod">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
    </select>

    <div id="slipWrap" style="margin-top:8px">
      <label style="font-size:13px">üìé ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="onlineSlip" type="file" accept="image/*" />
    </div>
    <div style="margin-top:14px;display:flex;justify-content:space-between;gap:8px">
      <button class="btn btn-delete" id="onlineCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-add" id="onlineConfirm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
    </div>
  </div>
</div>

<!-- Modal ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö UX ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û) -->
<div id="productModal" class="modal-backdrop">
  <div class="modal" style="width:720px">
    <h3>üìù ‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <!-- Progress -->
    <div style="display:flex;gap:6px;margin-bottom:12px">
      <div style="flex:1;height:6px;background:#e5e7eb;border-radius:999px"><div id="formProgress" style="width:30%;height:6px;background:var(--primary);border-radius:999px"></div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div style="grid-column:1/-1">
        <label>üìå ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input id="pm_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤ Nike Air Force 1" />
      </div>

      <div style="grid-column:1/-1">
        <label>üìù ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <textarea id="pm_brand_caption" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∏‡πà‡∏ô‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏ó‡πâ"></textarea>
      </div>

      <div><label>üè∑Ô∏è ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label><input id="pm_brand" placeholder="‡πÄ‡∏ä‡πà‡∏ô Nike"></div>
      <div><label>üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><input id="pm_category" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤"></div>

      <div><label>üßæ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</label><input id="pm_bill" placeholder="INV-0001"></div>
      <div><label>üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤</label><input id="pm_branch" placeholder="‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•"></div>

      <div><label>üí∞ ‡∏ó‡∏∏‡∏ô</label><input id="pm_cost" type="number" placeholder="0"></div>
      <div><label>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><input id="pm_price" type="number" placeholder="0"></div>

      <div><label>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</label><input id="pm_stock" type="number" placeholder="0"></div>

      <div style="grid-column:1/-1">
        <label>üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏£‡∏π‡∏õ)</label>
        <input id="pm_image" type="file" multiple accept="image/*">
        <div id="imagePreview" class="image-grid"></div>
      </div>
    </div>

    <div style="margin-top:18px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:12px;color:#6b7280">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-delete" id="pm_cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-add" id="pm_save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient('https://dfeaeyywbaywrvnudgvu.supabase.co','sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd',{auth:{persistSession:false}});

// helper ‡πÅ‡∏™‡∏î‡∏á error ‡∏à‡∏≤‡∏Å supabase
async function checkError(res, label){
  if(res.error){
    console.error(label, res.error);
    alert('‚ùå '+label+' : '+res.error.message);
    throw res.error;
  }
  return res.data;
}

const $ = id => document.getElementById(id);

// ===== Image Viewer (GLOBAL) =====
window.viewImage = (url) => {
  const viewer = document.getElementById('imageViewer');
  const img = document.getElementById('imageViewerImg');
  img.src = url;
  viewer.style.display = 'flex';
};

// ===== Download Images (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå) =====
window.downloadImages = async (productId) => {
  const product = allProducts.find(p => p.id === productId);
  if (!product || !product.image_urls || !product.image_urls.length) {
    return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
  }

  for (let i = 0; i < product.image_urls.length; i++) {
    const url = product.image_urls[i];
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = `product_${productId}_${i + 1}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(blobUrl);
    } catch (e) {
      console.error('download image error', e);
      alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }
};
let editingProduct=null,isCreateMode=false,tempImages=[];let currentReserveProduct=null;
let allProducts = [];
const productTable = document.getElementById('productTable');
const stats = document.getElementById('stats');
const searchInput = document.getElementById('searchInput');

async function loadProducts(){
  const {data}=await supabase.from('products').select('*').order('created_at',{ascending:false});
  allProducts = data || [];
  renderProducts(allProducts);
}

function renderProducts(list){
  renderStats(list);
  productTable.innerHTML=list.map(p=>{
    const imgs=p.image_urls||[];
    const img=imgs[0];
    const active=(p.reserved_by||[]).filter(r=>r.status!=='cancelled');
    return `<tr>
      <td>
        ${img?`<div style="display:flex;flex-direction:column;gap:4px;align-items:center">
          <img src="${img}" class="img-thumb" onclick="viewImage('${img}')">
          <button class="btn btn-edit" style="padding:4px 8px" onclick="downloadImages('${p.id}')">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        </div>`:'-'}
      </td>
      <td>${p.name||''}</td><td class="td-caption">${p.brand_caption||''}</td><td>${p.brand||''}</td><td>${p.inbound_bill||''}</td><td>${p.branch_address||''}</td><td>${p.category||''}</td>
      <td>${p.cost||0}</td><td>${p.price||0}</td><td>${p.stock||0}</td>
      <td>${active.map(r=>`${r.staff}(${r.qty})`).join(', ')||'-'}</td>
      <td>${active.length?'<span class="badge badge-res">‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á</span>':'<span class="badge badge-ok">‡∏ß‡πà‡∏≤‡∏á</span>'}</td>
      <td><div class="action-col">
        <button class="btn btn-add" onclick="sellFrontShop('${p.id}')">üõí ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
        <button class="btn btn-add" onclick="sellOnline('${p.id}')">üåê ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
        <button class="btn btn-add" onclick="openReserve('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≠‡∏á</button>
        <button class="btn btn-edit" onclick="viewCancelHistory('${p.id}')">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        <button class="btn btn-edit" onclick="openProduct('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div></td>
    </tr>`}).join('');
}

function renderStats(list){
  const totalStock = list.reduce((s,p)=>s+(p.stock||0),0);

  const byCategory = {};
  const byBrand = {};

  list.forEach(p=>{
    byCategory[p.category||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'] = (byCategory[p.category||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏']||0) + (p.stock||0);
    byBrand[p.brand||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'] = (byBrand[p.brand||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏']||0) + (p.stock||0);
  });

  let html = `
    <div class="card"><b>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°</b><div style="font-size:22px">${totalStock}</div></div>
    <div class="card"><b>üóÇÔ∏è ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</b>${Object.entries(byCategory).map(([k,v])=>`<div>${k}: <b>${v}</b></div>`).join('')}</div>
    <div class="card"><b>üè∑Ô∏è ‡∏ï‡∏≤‡∏°‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</b>${Object.entries(byBrand).map(([k,v])=>`<div>${k}: <b>${v}</b></div>`).join('')}</div>
  `;

  stats.innerHTML = html;
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö realtime
searchInput.oninput = () => {
  const q = searchInput.value.toLowerCase().trim();
  if(!q) return renderProducts(allProducts);
  const filtered = allProducts.filter(p =>
    (p.name||'').toLowerCase().includes(q) ||
    (p.brand||'').toLowerCase().includes(q) ||
    (p.inbound_bill||'').toLowerCase().includes(q) ||
    (p.branch_address||'').toLowerCase().includes(q) ||
    (p.category||'').toLowerCase().includes(q)
  );
  renderProducts(filtered);
};

window.openProduct=async id=>{const {data}=await supabase.from('products').select('*').eq('id',id).single();editingProduct=data;isCreateMode=false;tempImages=[];productModal.style.display='flex';pm_name.value=data.name||'';pm_brand_caption.value=data.brand_caption||'';pm_brand.value=data.brand||'';pm_category.value=data.category||'';pm_bill.value=data.inbound_bill||'';pm_branch.value=data.branch_address||'';pm_cost.value=data.cost||0;pm_price.value=data.price||0;pm_stock.value=data.stock||0;renderPreview(data.image_urls||[])};
openAddProduct.onclick=()=>{isCreateMode=true;editingProduct=null;tempImages=[];productModal.style.display='flex';['pm_name','pm_brand','pm_category','pm_bill','pm_branch','pm_cost','pm_price','pm_stock'].forEach(i=>$(i).value='');imagePreview.innerHTML=''};
pm_image.onchange = e => {
  [...e.target.files].forEach(file => {
    if (tempImages.length + (editingProduct?.image_urls?.length || 0) < 6) {
      tempImages.push(file);
    }
  });
  pm_image.value = '';
  renderPreview();
};
function renderPreview(existing = editingProduct?.image_urls || []) {
  imagePreview.innerHTML = '';

  // ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  existing.forEach((url, index) => {
    const div = document.createElement('div');
    div.className = 'image-item';
    div.innerHTML = `<img src="${url}"><button>‚úï</button>`;
    div.querySelector('button').onclick = () => {
      existing.splice(index, 1);
      if (editingProduct) editingProduct.image_urls = existing;
      renderPreview(existing);
    };
    imagePreview.appendChild(div);
  });

  // ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  tempImages.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'image-item';
    div.innerHTML = `<img src="${URL.createObjectURL(file)}"><button>‚úï</button>`;
    div.querySelector('button').onclick = () => {
      tempImages.splice(index, 1);
      renderPreview(existing);
    };
    imagePreview.appendChild(div);
  });
}
pm_save.onclick = async () => {
  // validation
  if(!pm_name.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  if(+pm_price.value <= 0) return alert('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
  if(+pm_stock.value < 0) return alert('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');

  let urls = editingProduct?.image_urls
    ? [...editingProduct.image_urls]
    : [];

  for (const file of tempImages) {
    const ext = file.name.split('.').pop();
    const path = `products/${crypto.randomUUID()}.${ext}`;
    await supabase.storage.from('product-images').upload(path, file);
    const publicUrl = supabase.storage
      .from('product-images')
      .getPublicUrl(path).data.publicUrl;
    urls.push(publicUrl);
  }

  const payload = {
    brand_caption: document.getElementById('pm_brand_caption')?.value || '',
    name: pm_name.value,
    brand: pm_brand.value,
    category: pm_category.value,
    inbound_bill: pm_bill.value,
    branch_address: pm_branch.value,
    cost: +pm_cost.value || 0,
    price: +pm_price.value || 0,
    stock: +pm_stock.value || 0,
    image_urls: urls
  };

  if (isCreateMode) {
    const { data, error } = await supabase
      .from('products')
      .insert(payload)
      .select()
      .single();

    if (error) {
      alert('‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      console.error(error);
      return;
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ list ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)
    allProducts.unshift(data);
    renderProducts(allProducts);

  } else {
    const { data, error } = await supabase
      .from('products')
      .update(payload)
      .eq('id', editingProduct.id)
      .select()
      .single();

    if (error) {
      alert('‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      console.error(error);
      return;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô list ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const idx = allProducts.findIndex(p => p.id === editingProduct.id);
    if (idx !== -1) {
      allProducts[idx] = data;
      renderProducts(allProducts);
    }
  }

  tempImages = [];
  productModal.style.display = 'none';
};
  

window.openReserve=async id=>{const {data}=await supabase.from('products').select('*').eq('id',id).single();currentReserveProduct=data;modal.style.display='flex';renderReserve()};
function renderReserve(){reserveList.innerHTML='';(currentReserveProduct.reserved_by||[]).forEach((r,i)=>{reserveList.innerHTML+=`<div class="reserve-row"><span>${r.staff} (${r.qty}) - ${r.status}</span>${r.status!=='cancelled'?`<button class="btn btn-delete" onclick="cancelReserve(${i})">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`:''}</div>`})}
window.cancelReserve=async idx=>{const list=currentReserveProduct.reserved_by||[];list[idx].status='cancelled';currentReserveProduct.stock+=list[idx].qty;await supabase.from('products').update({reserved_by:list,stock:currentReserveProduct.stock}).eq('id',currentReserveProduct.id);renderReserve();loadProducts()};
addReserveBtn.onclick=async()=>{if(!currentReserveProduct)return;const qty=+qtyInput.value||0;if(qty<=0||qty>currentReserveProduct.stock)return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');const entry={staff:staffInput.value,qty,branch:currentReserveProduct.branch_address,status:'active',at:new Date().toISOString()};const list=currentReserveProduct.reserved_by||[];list.push(entry);await supabase.from('products').update({reserved_by:list,stock:currentReserveProduct.stock-qty}).eq('id',currentReserveProduct.id);staffInput.value='';qtyInput.value='';renderReserve();loadProducts()};
closeModalBtn.onclick=()=>modal.style.display='none';window.viewCancelHistory=async id=>{
  const {data}=await supabase.from('products').select('*').eq('id',id).single();
  const cancelled=(data.reserved_by||[]).filter(r=>r.status==='cancelled');
  let html='<h3>üìï ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>';
  if(!cancelled.length){html+='<p style="font-size:13px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</p>'}
  cancelled.forEach(r=>{html+=`<div class="reserve-row"><span>${r.staff} (${r.qty}) - ${new Date(r.at||'').toLocaleString()}</span></div>`});
  const wrap=document.createElement('div');
  wrap.className='modal-backdrop';
  wrap.style.display='flex';
  wrap.innerHTML=`<div class="modal" style="width:420px">${html}<div style="text-align:right;margin-top:10px"><button class="btn btn-delete">‡∏õ‡∏¥‡∏î</button></div></div>`;
  wrap.querySelector('button').onclick=()=>wrap.remove();
  document.body.appendChild(wrap);
};pm_cancel.onclick=()=>productModal.style.display='none';// ====== ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS) ======
let sellingProduct = null;

window.sellFrontShop = async (productId) => {
  const product = allProducts.find(p => p.id === productId);
  if (!product) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  if (product.stock <= 0) return alert('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠');

  sellingProduct = product;
  posProductName.textContent = product.name;
  posStock.textContent = product.stock;
  posQty.value = 1;
  posModal.style.display = 'flex';
};

posCancel.onclick = () => {
  posModal.style.display = 'none';
  sellingProduct = null;
};

posConfirm.onclick = async () => {
  if (!sellingProduct) return;

  if (!posBranch.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢');
  if (!posStaff.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');

  const qty = +posQty.value || 0;
  if (qty <= 0 || qty > sellingProduct.stock) return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

  const total = qty * sellingProduct.price;

  const res = await supabase.from('sales').insert({
    product_id: sellingProduct.id,
    product_name: sellingProduct.name,
    channel: 'store sales',
    platform: 'pos',
    branch: posBranch.value,
    staff: posStaff.value,
    qty,
    price: sellingProduct.price,
    total
  });

  await checkError(res,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô');

  await supabase.from('products')
    .update({ stock: sellingProduct.stock - qty })
    .eq('id', sellingProduct.id);

  posModal.style.display = 'none';
  sellingProduct = null;
  posBranch.value = '';
  posStaff.value = '';
  alert('‚úÖ ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  loadProducts();
};

// ====== ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ======
let onlineProduct = null;

window.sellOnline = (productId) => {
  if (!onlineModal || !onlineProductName) {
    alert('‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
    return;
  }
  const product = allProducts.find(p => p.id === productId);
  if (!product) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  if (product.stock <= 0) return alert('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠');

  onlineProduct = product;
  onlineProductName.textContent = product.name;
  onlineQty.value = 1;
  onlineCustomerName.value = '';
  onlineCustomerPhone.value = '';
  onlineCustomerAddress.value = '';
  onlinePaymentType.value = 'transfer';
  slipWrap.style.display = 'block';
  onlineModal.style.display = 'flex';

  onlinePaymentType.onchange = () => {
    slipWrap.style.display = onlinePaymentType.value === 'transfer' ? 'block' : 'none';
  };
};

onlineCancel.onclick = () => {
  onlineModal.style.display = 'none';
  onlineProduct = null;
};

onlineConfirm.onclick = async () => {
  if (!onlineProduct) return;
  if (!onlineCustomerName.value || !onlineCustomerPhone.value || !onlineCustomerAddress.value) {
    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  }

  const qty = +onlineQty.value || 0;
  if (qty <= 0 || qty > onlineProduct.stock) return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

  const total = qty * onlineProduct.price;

  let slipUrl = null;
  if (onlinePaymentType.value === 'transfer') {
    const file = onlineSlip.files[0];
    if (!file) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
    const ext = file.name.split('.').pop();
    const path = `slips/${crypto.randomUUID()}.${ext}`;
    const uploadRes = await supabase.storage.from('payment-slips').upload(path, file);
    if (uploadRes.error) {
      console.error('upload slip error', uploadRes.error);
      alert('‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + uploadRes.error.message);
      return;
    }
    slipUrl = supabase.storage.from('payment-slips').getPublicUrl(path).data.publicUrl;
  }

    const res = await supabase.from('sell_online').insert({
    customer_name: onlineCustomerName.value,
    customer_phone: onlineCustomerPhone.value,
    customer_address: onlineCustomerAddress.value,
    product_id: onlineProduct.id,
    product_name: onlineProduct.name,
    branch: onlineBranch.value,
    staff_name: onlineStaff.value,
    price: onlineProduct.price,
    qty,
    total,
    payment_type: onlinePaymentType.value,
    slip_url: slipUrl,
    status: 'online'
  });

  await supabase.from('products')
    .update({ stock: onlineProduct.stock - qty })
    .eq('id', onlineProduct.id);

  onlineModal.style.display = 'none';
  onlineProduct = null;
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß');
  loadProducts();
};

loadProducts();
</script>
</body>
</html>







‡∏Å‡∏´‡∏î‡∏´‡∏Å‡∏î‡∏´‡∏Å‡∏î
‡∏Å‡∏î‡∏Å‡∏´‡∏î‡∏´‡∏Å‡∏î
  ‡∏Å‡∏î‡∏´‡∏Å‡∏î
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseAuth = createClient('https://dfeaeyywbaywrvnudgvu.supabase.co','sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd');

const loginPage = document.getElementById('loginPage');
const loginBtn = document.getElementById('loginBtn');
const loginErr = document.getElementById('loginErr');

// üîê Auth Guard
// üîê Auth Guard + Logout
supabaseAuth.auth.onAuthStateChange((_event, session)=>{
  if(session){
    loginPage.style.display='none';
  }else{
    loginPage.style.display='flex';
  }
});

// üîì Logout
const logoutBtn = document.getElementById('logoutBtn');
if(logoutBtn){
  logoutBtn.onclick = async ()=>{
    try {
      await supabaseAuth.auth.signOut();
      localStorage.clear();
      location.reload();
    } catch(err) {
      console.error('‚ùå Logout error:', err);
      alert('‚ùå ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    }
  };
}

loginBtn.onclick = async () => {
  try {
    loginErr.style.display='none';
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPass').value;
    
    // ‚úÖ Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!email || !emailRegex.test(email)){
      loginErr.innerText='‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      loginErr.style.display='block';
      return;
    }
    
    // ‚úÖ Password validation
    if(!password || password.length < 6){
      loginErr.innerText='‚ùå Password ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ';
      loginErr.style.display='block';
      return;
    }
    
    // ‚úÖ Login with rate limiting
    loginBtn.disabled = true;
    loginBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
    
    const { error } = await supabaseAuth.auth.signInWithPassword({ email, password });
    if(error){
      loginErr.innerText = '‚ùå ' + (error.message || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      loginErr.style.display='block';
      console.error('Login error:', error);
    } else {
      alert('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
    }
  } catch(err) {
    console.error('‚ùå Login exception:', err);
    loginErr.innerText='‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err?.message || 'Unknown');
    loginErr.style.display='block';
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
  }
};
</script>



</body>
</html>


</div>

<div id="orderSection" class="section">
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>Admin Pro | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root{--primary:#2563eb;--success:#16a34a;--warning:#f59e0b;--danger:#dc2626;--bg:#f8fafc;--card:#fff;--text:#1e293b}
        *{box-sizing:border-box; font-family: 'Segoe UI', Tahoma, sans-serif;}
        body{background:var(--bg);color:var(--text);margin:0;padding:20px}
        
        .container{max-width:100%;margin:auto}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:15px;flex-wrap:wrap}
        
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05);border-left:4px solid var(--primary)}

        .table-wrap{background:var(--card);border-radius:14px;box-shadow:0 10px 25px -5px rgba(0,0,0,0.08);overflow-x:auto}
        table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;min-width:1200px}
        th,td{padding:12px 14px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top}
        th{background:#f8fafc;font-weight:600;color:#475569;position:sticky;top:0;z-index:10}
        
        /* Status Tags */
        .status{padding:4 px 6 px;border-radius:999px;font-size:8px;font-weight:700;display:inline-flex;align-items:center;gap:4px}
        .pending{background:#fef3c7;color:#92400e}
        .paid{background:#dcfce7;color:#166534}
        .rejected{background:#fee2e2;color:#991b1b}
        .shipped{background:#e0f2fe;color:#0369a1}
        .delivered{background:#dcfce7;color:#15803d}
        .cancelled{background:#f1f5f9;color:#64748b}

        .btn{padding:4 px 6px;border-radius:8px;border:none;cursor:pointer;font-size:8px;font-weight:600;transition:all 0.15s ease;display:inline-flex;align-items:center;gap:6px;justify-content:center;white-space:nowrap}
        .btn:hover{opacity:0.85;transform:translateY(-1px)}
        .btn.primary{background:var(--primary);color:#fff}
        .btn.success{background:var(--success);color:#fff}
        .btn.danger{background:var(--danger);color:#fff}
        .btn.warning{background:var(--warning);color:#fff}
        .btn.outline{background:transparent;border:1px solid #cbd5e1;color:#64748b}
        .btn.outline-danger{background:transparent;border:1px solid var(--danger);color:var(--danger)}

        input.track, input.search{padding:10px 14px;border-radius:10px;border:1px solid #cbd5e1;transition:0.15s ease}
        input.search{width:100%;max-width:400px}
        
        .item-list{background:#f8fafc;padding:20px;border-radius:8px;margin:10px;border:1px dashed #cbd5e1}
        #slipModal{position:fixed;inset:0;background:rgba(15,23,42,0.8);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
    </style>
</head>
<body>

<div id="slipModal" onclick="this.style.display='none'">
    <div style="background:#fff;border-radius:16px;max-width:450px;width:90%;padding:15px;position:relative" onclick="event.stopPropagation()">
        <img id="slipImage" src="" style="width:100%;border-radius:10px" />
        <div style="display:flex;gap:10px;margin-top:15px">
            <button onclick="document.getElementById('slipModal').style.display='none'" class="btn outline" style="flex:1">‡∏õ‡∏¥‡∏î</button>
            <a id="downloadSlip" href="#" download class="btn primary" style="flex:1;text-decoration:none">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</a>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0;font-size:24px">üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Admin)</h1>
            <p style="margin:5px 0 0;color:#64748b" id="orderCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
        <div style="display:flex;gap:10px;flex:1;justify-content:flex-end">
            <input id="searchInputOrder" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå..." />
            <button onclick="loadOrders()" class="btn outline">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
    </div>

    <div class="stats-grid" id="statsBoard"></div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                  <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• (inbound_bill)</th>
                  <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Order ID)</th>
                  <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                  <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                  <th>‡∏¢‡∏≠‡∏î</th>
                  <th>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                  <th>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô / ‡∏™‡∏•‡∏¥‡∏õ</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                  <th>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                </tr>
            </thead>
            <tbody id="orderTable">
                <tr><td colspan="13" style="text-align:center;padding:50px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://dfeaeyywbaywrvnudgvu.supabase.co';
const SUPABASE_KEY = 'sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd'; 
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// üî¥ Supabase Realtime: ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
const realtimeChannel = sb.channel('orders-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
    console.log('Realtime orders update:', payload);
    loadOrders();
  })
  .subscribe();

let ALL_ORDERS = [];
const statusMap = { 'paid': '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', 'rejected': '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', 'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' };

async function loadOrders() {
    try {
        const { data, error } = await sb
            .from('orders')
            .select(`*, order_items(*, products(inbound_bill))`)
            .order('created_at', { ascending: false });

        if(error) throw error;
        ALL_ORDERS = data || [];
        updateStats();
        render(ALL_ORDERS);
    } catch (err) {
        Swal.fire('Error', err.message, 'error');
    }
}

function updateStats() {
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏•‡∏¥‡∏õ / ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    const slipApproved = ALL_ORDERS.filter(o => o.payment_status === 'paid').length;
    const slipRejected = ALL_ORDERS.filter(o => o.payment_status === 'rejected').length;

    // ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å status ‡∏à‡∏£‡∏¥‡∏á)
    const delivering = ALL_ORDERS.filter(o => o.status === 'shipped').length;
    const deliveredSuccess = ALL_ORDERS.filter(o => o.status === 'delivered').length;
    const deliveredFailed = ALL_ORDERS.filter(o => o.status === 'cancelled').length;

    document.getElementById('orderCount').innerText = `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${ALL_ORDERS.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    document.getElementById('statsBoard').innerHTML = `
        <div class="stat-card" style="border-left-color:var(--success)">
            <b>‚úÖ ‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</b>
            <div class="stat-number success">${slipApproved}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--danger)">
            <b>‚ùå ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</b>
            <div class="stat-number danger">${slipRejected}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--primary)">
            <b>üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</b>
            <div class="stat-number primary">${delivering}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--success)">
            <b>üì¶ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b>
            <div class="stat-number success">${deliveredSuccess}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--danger)">
            <b>üìõ ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b>
            <div class="stat-number danger">${deliveredFailed}</div>
        </div>
    `;
}

function render(list) {
    const tb = document.getElementById('orderTable');
    tb.innerHTML = list.length ? '' : '<tr><td colspan="13" style="text-align:center;padding:40px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</td></tr>';

    list.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><b>${o.order_items?.[0]?.products?.inbound_bill || '-'}</b></td>
            <td><small>${o.id}</small></td>
            <td>
                ${o.customer_name}
            </td>
            <td>
                <small>${o.customer_address || '-'}</small>
            </td>
            <td>
                ${o.customer_phone || '-'}
            </td>
            <td style="font-weight:600">‡∏ø${Number(o.total_amount).toLocaleString()}</td>
            <td>
                <span class="status ${o.payment_status}">
                    ${o.delivery_type === 'pickup' ? 'üè™ ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö' : (statusMap[o.payment_status] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞')}
                </span>
            </td>
            <td>
                ${o.delivery_type === 'delivery' && o.slip_url ? `
                    <button class=\"btn outline btn-slip\" data-url=\"${o.slip_url}\">üßæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ</button>
                    ${o.payment_status === 'pending' ? `
                        <div style="margin-top:6px;display:flex;flex-direction:column;gap:6px">
    <button class="btn success btn-approve" data-id="${o.id}">‚úî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
    <button class="btn danger btn-reject" data-id="${o.id}">‚úñ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
</div>
                    ` : ''}
                ` : '-'}
            </td>
            <td>
                ${o.status === 'delivered'
                    ? '<span class="status delivered">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>'
                    : o.status === 'cancelled'
                        ? '<span class="status cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>'
                        : o.status === 'shipped'
                            ? '<span class="status shipped">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>'
                            : '<span class="status pending">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>'}
            </td>
            <td>${o.tracking_no || '-'}</td>
            <td>${renderActionButtons(o)}</td>
            <td><small>${new Date(o.created_at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}</small></td>
            <td><button class="btn outline btn-items" data-id="${o.id}">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
        `;
        tb.appendChild(tr);

        const itemRow = document.createElement('tr');
        itemRow.id = `items-${o.id}`;
        itemRow.style.display = 'none';
        itemRow.innerHTML = `<td colspan="13"><div class="item-list" id="box-${o.id}"></div></td>`;
        tb.appendChild(itemRow);
    });
    bindActions();
}

function renderActionButtons(o) {
    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    if (o.status === 'cancelled') return '<span style="color:gray">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';

    // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    if (o.status === 'delivered') return '<span class="status delivered">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';

    // üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á + ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß + ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
    if (o.delivery_type === 'delivery' && o.payment_status === 'paid' && o.status === 'pending') {
        return `
            <div style="display:flex; gap:5px; flex-wrap:wrap">
                <button class="btn primary" onclick="promptTracking('${o.id}')">üöö ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
                <button class="btn danger" onclick="handleCancel('${o.id}')">üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
    }

    // üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á + ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    if (o.delivery_type === 'delivery' && o.status === 'shipped') {
        return `
            <div style="display:flex; gap:5px; flex-wrap:wrap">
                <button class="btn success" onclick="updateOrder('${o.id}', {status:'delivered'})">üì¶ ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</button>
                <button class="btn danger" onclick="handleCancel('${o.id}')">‚Ü©Ô∏è ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö </button>
            </div>
        `;
    }

    // üè™ ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö (pickup) ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ
    if (o.delivery_type === 'pickup' && o.status === 'pending') {
        return `
            <div style="display:flex; gap:5px; flex-wrap:wrap">
                <button class="btn success" onclick="updateOrder('${o.id}', {status:'delivered'})">‚úÖ ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>
                <button class="btn warning" onclick="handleCancel('${o.id}')">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö </button>
            </div>
        `;
    }

    // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    return '<small style="color:#94a3b8">-</small>';
}

function bindActions() {
    document.querySelectorAll('.btn-slip').forEach(b => b.onclick = () => openSlip(b.dataset.url));
    document.querySelectorAll('.btn-items').forEach(b => b.onclick = () => toggleItems(b.dataset.id));
    
    document.querySelectorAll('.btn-approve').forEach(b => b.onclick = () => updateOrder(b.dataset.id, {payment_status:'paid'}));
    document.querySelectorAll('.btn-reject').forEach(b => b.onclick = () => handleReject(b.dataset.id));

    document.querySelectorAll('.btn-save').forEach(b => b.onclick = () => {
        const track = document.getElementById(`track-${b.dataset.id}`).value;
        if(!track) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏', 'warning');
        updateOrder(b.dataset.id, { tracking_no: track, status: 'shipped' });
    });

    document.querySelectorAll('.btn-delivered, .btn-pickup-ok').forEach(b => b.onclick = () => updateOrder(b.dataset.id, {status:'delivered'}));

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô shipped)
    document.querySelectorAll('.btn-return').forEach(b => b.onclick = async () => {
        const res = await Swal.fire({
            title: '‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?',
            text: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Cancelled ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö'
        });
        if(res.isConfirmed) updateOrder(b.dataset.id, {status: 'cancelled', tracking_no: null});
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
    document.querySelectorAll('.btn-cancel').forEach(b => b.onclick = async () => {
        const res = await Swal.fire({
            title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå?',
            text: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Cancelled",
            icon: 'error',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
        });
        if(res.isConfirmed) updateOrder(b.dataset.id, {status: 'cancelled'});
    });
}

async function promptTracking(orderId) {
    const { value: tracking } = await Swal.fire({
        title: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏',
        input: 'text',
        inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô TH123456789',
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
        inputValidator: (value) => {
            if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏';
        }
    });

    if (tracking) {
        updateOrder(orderId, { tracking_no: tracking, status: 'shipped' });
    }
}

async function updateOrder(id, payload) {
    const { error } = await sb.from('orders').update(payload).eq('id', id);
    if(error) return Swal.fire('Error', error.message, 'error');
    Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', timer: 800, showConfirmButton: false });
}

// ‚úÖ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏•‡∏¥‡∏õ ‚Üí ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå + ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
async function handleReject(orderId) {
    const res = await Swal.fire({
        title: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
    });
    if (!res.isConfirmed) return;
    await handleCancel(orderId);
}

// ‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå + ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
async function handleCancel(orderId) {
    const res = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?',
        text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'
    });
    if (!res.isConfirmed) return;

    try {
        const order = ALL_ORDERS.find(o => o.id === orderId);
        const items = order.order_items || [];

        for (const item of items) {
            const { data: p } = await sb.from('products').select('stock').eq('id', item.product_id).single();
            if (p) {
                const newStock = (p.stock || 0) + (item.qty || 0);
                await sb.from('products').update({ stock: newStock }).eq('id', item.product_id);
            }
        }

        await sb.from('orders').update({ status: 'cancelled', payment_status: 'rejected' }).eq('id', orderId);
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } catch (err) {
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
    }
}

function toggleItems(id) {
    const row = document.getElementById(`items-${id}`);
    const box = document.getElementById(`box-${id}`);
    if(row.style.display === 'table-row') { row.style.display = 'none'; return; }
    
    row.style.display = 'table-row';
    const order = ALL_ORDERS.find(o => o.id === id);
    box.innerHTML = `
        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:20px">
            <div>
                <strong>üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong><br/>
                <p style="margin:5px 0 15px; color:#475569">${order.customer_address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <strong>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong><br/>
                <table style="min-width:400px; margin-top:10px; background:white; border-radius:8px; border:1px solid #eee">
                    <tr style="background:#f8fafc"><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr>
                    ${(order.order_items || []).map(i => `<tr><td>${i.product_name}</td><td>${i.qty}</td><td>‡∏ø${i.price}</td></tr>`).join('')}
                </table>
            </div>
            <div style="text-align:right">
                <small>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(order.created_at).toLocaleString('th-TH')}</small>
            </div>
        </div>
    `;
}

function openSlip(url) {
    document.getElementById('slipImage').src = url;
    document.getElementById('downloadSlip').href = url;
    document.getElementById('slipModal').style.display = 'flex';
}

const orderSearchInput = document.getElementById('searchInputOrder');
if(orderSearchInput){
  orderSearchInput.oninput = (e) => {
    const q = e.target.value.toLowerCase().trim();
    if(!q){ render(ALL_ORDERS); return; }
    const filtered = ALL_ORDERS.filter(o => 
      (o.customer_name || '').toLowerCase().includes(q) || 
      (o.customer_phone || '').includes(q) ||
      (o.id || '').toLowerCase().includes(q)
    );
    render(filtered);
  };
}

loadOrders();

</script>
</body>
</html>

</div>

<script>
const tabStock = document.getElementById('tabStock');
const tabOrders = document.getElementById('tabOrders');
const tabSales  = document.getElementById('tabSales');

const stockSection = document.getElementById('stockSection');
const orderSection = document.getElementById('orderSection');
const salesSection = document.getElementById('salesSection');

function activate(tab){
  // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å section
  [stockSection, orderSection, salesSection].forEach(s =>
    s && s.classList.remove('active')
  );

  // ‡∏õ‡∏¥‡∏î active ‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°
  [tabStock, tabOrders, tabSales].forEach(b =>
    b && b.classList.remove('active')
  );

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î
  if(tab === 'stock'){
    tabStock.classList.add('active');
    stockSection.classList.add('active');
  }

  if(tab === 'orders'){
    tabOrders.classList.add('active');
    orderSection.classList.add('active');
  }

  if(tab === 'sales'){
    tabSales.classList.add('active');
    salesSection.classList.add('active');
  }
}


// ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
tabStock.onclick  = () => activate('stock');
tabOrders.onclick = () => activate('orders');
tabSales.onclick  = () => activate('sales');
</script>

</body>
</html>

<div id="salesSection" class="section">
<div class="container">
  <h2>üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>

  <!-- Summary -->
  <div class="summary">
    <div class="sum-card"><span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><b id="sumTotal">-</b></div>
    <div class="sum-card"><span>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</span><b id="sumProfit" class="profit">-</b></div>
    <div class="sum-card"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span><b id="sumCount">-</b></div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px">
    <div class="tabs">
      <div class="tab active" id="tabStore">üõí ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div>
      <div class="tab" id="tabOnline">üåê ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
    </div>
    <input id="searchSalesInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
  </div>


  <div class="card">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

</html>
