<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel | Stock & Orders</title>
<style>
:root{--primary:#2563eb;--bg:#f8fafc;--card:#fff;--text:#111827}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:var(--bg);color:var(--text)}

/* ===== Navbar ===== */
.navbar{position:sticky;top:0;z-index:999;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#111827;color:#fff}
.navbar h1{font-size:18px;margin:0}
.navbar .menu{display:flex;gap:10px}
.navbar button{background:transparent;border:none;color:#e5e7eb;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:14px}
.navbar button.active,.navbar button:hover{background:var(--primary);color:#fff}
.navbar .logout{background:#dc2626;color:#fff}
.navbar .logout:hover{background:#b91c1c}
.navbar button.active,.navbar button:hover{background:var(--primary);color:#fff}

.section{display:none;padding:20px}
.section.active{display:block}

iframe{width:100%;height:calc(100vh - 80px);border:none;border-radius:16px;background:#fff}
</style>
</head>
<body>
<!-- üîê SUPABASE LOGIN -->
<div id="loginPage" style="position:fixed;inset:0;background:#f1f5f9;display:flex;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;padding:24px;border-radius:14px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h3 style="margin-top:0">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <input id="loginEmail" type="email" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px" />
    <input id="loginPass" type="password" placeholder="Password" style="width:100%;padding:10px;margin-bottom:12px" />
    <button id="loginBtn" style="width:100%;padding:10px;background:#2563eb;color:#fff;border:none;border-radius:8px">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <p id="loginErr" style="color:#dc2626;font-size:13px;display:none;margin-top:8px"></p>
  </div>
</div>


<!-- ===== Navigation ===== -->
<div class="navbar">
  <h1>üß† Admin Control</h1>
  <div class="menu">
    <button id="tabStock" class="active">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button id="tabOrders">üßæ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="logoutBtn" class="logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</div>
</div>

<!-- ===== Sections ===== -->
<div id="stockSection" class="section active">
  <!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Production)</title>
<style>
:root{--primary:#2563eb;--success:#16a34a;--danger:#dc2626;--light:#f3f4f6;--dark:#111827}
body{font-family:Inter,system-ui;background:#f8fafc;margin:0;padding:20px;color:#111}
.container{max-width:1400px;margin:auto}
h2{border-left:6px solid var(--primary);padding-left:12px;margin-bottom:12px}
.card{background:#fff;padding:20px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.btn{padding:8px 14px;border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:13px}
.btn-add{background:var(--success)}
.btn-edit{background:#f59e0b}
.btn-delete{background:var(--danger)}
.badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
.badge-ok{background:#dcfce7;color:#166534}
.badge-res{background:#fee2e2;color:#991b1b}
input,textarea{padding:8px;border:1px solid #ddd;border-radius:8px;font-size:13px}
input:focus,textarea:focus{outline:none;border-color:var(--primary)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px;vertical-align:top}
th{color:#374151;font-weight:600}
.img-thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;background:#e5e7eb}
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal{background:#fff;padding:20px;border-radius:16px;width:420px;max-width:94%}
.modal h3{margin-top:0}
.reserve-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:13px}
.image-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
.image-item{position:relative}
.image-item img{width:100%;height:80px;object-fit:cover;border-radius:8px}
.image-item button{position:absolute;top:4px;right:4px;border:none;background:rgba(0,0,0,.6);color:#fff;border-radius:999px;width:22px;height:22px;cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠ / ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / ‡∏™‡∏≤‡∏Ç‡∏≤)" style="min-width:320px" />
      <button class="btn btn-add" id="openAddProduct">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>
  </div>
  <div class="card" style="margin-bottom:16px">
  <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
  <div id="stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px"></div>
</div>
<div class="card">
  <table>
      <thead>
        <tr>
          <th>‡∏£‡∏π‡∏õ</th><th>‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô</th><th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡∏™‡∏≤‡∏Ç‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th>‡∏ó‡∏∏‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th><th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </div>
</div>

<!-- Modal ‡∏à‡∏≠‡∏á -->
<div id="modal" class="modal-backdrop"><div class="modal">
  <h3>‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
  <div id="reserveList"></div>
  <div style="display:flex;gap:6px;margin-top:10px">
    <input id="staffInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />
    <input id="qtyInput" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" />
    <button class="btn btn-add" id="addReserveBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
  </div>
  <div style="margin-top:14px;text-align:right"><button class="btn btn-delete" id="closeModalBtn">‡∏õ‡∏¥‡∏î</button></div>
</div></div>

<!-- Modal ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö UX ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û) -->
<div id="productModal" class="modal-backdrop">
  <div class="modal" style="width:720px">
    <h3>üìù ‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <!-- Progress -->
    <div style="display:flex;gap:6px;margin-bottom:12px">
      <div style="flex:1;height:6px;background:#e5e7eb;border-radius:999px"><div id="formProgress" style="width:30%;height:6px;background:var(--primary);border-radius:999px"></div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div style="grid-column:1/-1">
        <label>üìå ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <textarea id="pm_name" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤ Nike Air Force 1 ‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà"></textarea>
      </div>

      <div><label>üè∑Ô∏è ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label><input id="pm_brand" placeholder="‡πÄ‡∏ä‡πà‡∏ô Nike"></div>
      <div><label>üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><input id="pm_category" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤"></div>

      <div><label>üßæ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</label><input id="pm_bill" placeholder="INV-0001"></div>
      <div><label>üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤</label><input id="pm_branch" placeholder="‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•"></div>

      <div><label>üí∞ ‡∏ó‡∏∏‡∏ô</label><input id="pm_cost" type="number" placeholder="0"></div>
      <div><label>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><input id="pm_price" type="number" placeholder="0"></div>

      <div><label>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</label><input id="pm_stock" type="number" placeholder="0"></div>

      <div style="grid-column:1/-1">
        <label>üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏£‡∏π‡∏õ)</label>
        <input id="pm_image" type="file" multiple accept="image/*">
        <div id="imagePreview" class="image-grid"></div>
      </div>
    </div>

    <div style="margin-top:18px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:12px;color:#6b7280">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-delete" id="pm_cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-add" id="pm_save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient('https://dfeaeyywbaywrvnudgvu.supabase.co','sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd');
const $=id=>document.getElementById(id);
let editingProduct=null,isCreateMode=false,tempImages=[];let currentReserveProduct=null;
let allProducts = [];

async function loadProducts(){
  const {data}=await supabase.from('products').select('*').order('created_at',{ascending:false});
  allProducts = data || [];
  renderProducts(allProducts);
}

function renderProducts(list){
  renderStats(list);
  productTable.innerHTML=list.map(p=>{
    const img=p.image_urls?.[0];
    const active=(p.reserved_by||[]).filter(r=>r.status!=='cancelled');
    return `<tr>
      <td>${img?`<img src="${img}" class="img-thumb">`:'-'}</td>
      <td>${p.name||''}</td><td>${p.brand||''}</td><td>${p.inbound_bill||''}</td><td>${p.branch_address||''}</td><td>${p.category||''}</td>
      <td>${p.cost||0}</td><td>${p.price||0}</td><td>${p.stock||0}</td>
      <td>${active[0]?.branch||'-'}</td><td>${active.map(r=>`${r.staff}(${r.qty})`).join(', ')||'-'}</td>
      <td>${active.length?'<span class="badge badge-res">‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á</span>':'<span class="badge badge-ok">‡∏ß‡πà‡∏≤‡∏á</span>'}</td>
      <td style="display:flex;flex-direction:column;gap:6px">
        <button class="btn btn-add" onclick="openReserve('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≠‡∏á</button>
        <button class="btn btn-edit" onclick="viewCancelHistory('${p.id}')">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        <button class="btn btn-edit" onclick="openProduct('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </td>
    </tr>`}).join('');
}

function renderStats(list){
  const totalStock = list.reduce((s,p)=>s+(p.stock||0),0);

  const byCategory = {};
  const byBrand = {};

  list.forEach(p=>{
    byCategory[p.category||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'] = (byCategory[p.category||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏']||0) + (p.stock||0);
    byBrand[p.brand||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'] = (byBrand[p.brand||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏']||0) + (p.stock||0);
  });

  let html = `
    <div class="card"><b>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°</b><div style="font-size:22px">${totalStock}</div></div>
    <div class="card"><b>üóÇÔ∏è ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</b>${Object.entries(byCategory).map(([k,v])=>`<div>${k}: <b>${v}</b></div>`).join('')}</div>
    <div class="card"><b>üè∑Ô∏è ‡∏ï‡∏≤‡∏°‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</b>${Object.entries(byBrand).map(([k,v])=>`<div>${k}: <b>${v}</b></div>`).join('')}</div>
  `;

  stats.innerHTML = html;
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö realtime
searchInput.oninput = () => {
  const q = searchInput.value.toLowerCase().trim();
  if(!q) return renderProducts(allProducts);
  const filtered = allProducts.filter(p =>
    (p.name||'').toLowerCase().includes(q) ||
    (p.brand||'').toLowerCase().includes(q) ||
    (p.inbound_bill||'').toLowerCase().includes(q) ||
    (p.branch_address||'').toLowerCase().includes(q) ||
    (p.category||'').toLowerCase().includes(q)
  );
  renderProducts(filtered);
};

window.openProduct=async id=>{const {data}=await supabase.from('products').select('*').eq('id',id).single();editingProduct=data;isCreateMode=false;tempImages=[];productModal.style.display='flex';pm_name.value=data.name||'';pm_brand.value=data.brand||'';pm_category.value=data.category||'';pm_bill.value=data.inbound_bill||'';pm_branch.value=data.branch_address||'';pm_cost.value=data.cost||0;pm_price.value=data.price||0;pm_stock.value=data.stock||0;renderPreview(data.image_urls||[])};
openAddProduct.onclick=()=>{isCreateMode=true;editingProduct=null;tempImages=[];productModal.style.display='flex';['pm_name','pm_brand','pm_category','pm_bill','pm_branch','pm_cost','pm_price','pm_stock'].forEach(i=>$(i).value='');imagePreview.innerHTML=''};
pm_image.onchange = e => {
  [...e.target.files].forEach(file => {
    if (tempImages.length + (editingProduct?.image_urls?.length || 0) < 6) {
      tempImages.push(file);
    }
  });
  pm_image.value = '';
  renderPreview();
};
function renderPreview(existing = editingProduct?.image_urls || []) {
  imagePreview.innerHTML = '';

  // ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  existing.forEach((url, index) => {
    const div = document.createElement('div');
    div.className = 'image-item';
    div.innerHTML = `<img src="${url}"><button>‚úï</button>`;
    div.querySelector('button').onclick = () => {
      existing.splice(index, 1);
      if (editingProduct) editingProduct.image_urls = existing;
      renderPreview(existing);
    };
    imagePreview.appendChild(div);
  });

  // ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  tempImages.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'image-item';
    div.innerHTML = `<img src="${URL.createObjectURL(file)}"><button>‚úï</button>`;
    div.querySelector('button').onclick = () => {
      tempImages.splice(index, 1);
      renderPreview(existing);
    };
    imagePreview.appendChild(div);
  });
}
pm_save.onclick = async () => {
  // validation
  if(!pm_name.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  if(+pm_price.value <= 0) return alert('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
  if(+pm_stock.value < 0) return alert('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');

  let urls = editingProduct?.image_urls
    ? [...editingProduct.image_urls]
    : [];

  // upload ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
  for (const file of tempImages) {
    const ext = file.name.split('.').pop();
    const path = `products/${crypto.randomUUID()}.${ext}`;
    await supabase.storage.from('product-images').upload(path, file);
    const publicUrl = supabase.storage
      .from('product-images')
      .getPublicUrl(path).data.publicUrl;
    urls.push(publicUrl);
  }

  const payload = {
    name: pm_name.value,
    brand: pm_brand.value,
    category: pm_category.value,
    inbound_bill: pm_bill.value,
    branch_address: pm_branch.value,
    cost: +pm_cost.value || 0,
    price: +pm_price.value || 0,
    stock: +pm_stock.value || 0,
    image_urls: urls
  };

  if (isCreateMode) {
    await supabase.from('products').insert(payload);
  } else {
    await supabase.from('products')
      .update(payload)
      .eq('id', editingProduct.id);
  }

  tempImages = [];
  productModal.style.display = 'none';
  loadProducts();
};

window.openReserve=async id=>{const {data}=await supabase.from('products').select('*').eq('id',id).single();currentReserveProduct=data;modal.style.display='flex';renderReserve()};
function renderReserve(){reserveList.innerHTML='';(currentReserveProduct.reserved_by||[]).forEach((r,i)=>{reserveList.innerHTML+=`<div class="reserve-row"><span>${r.staff} (${r.qty}) - ${r.status}</span>${r.status!=='cancelled'?`<button class="btn btn-delete" onclick="cancelReserve(${i})">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`:''}</div>`})}
window.cancelReserve=async idx=>{const list=currentReserveProduct.reserved_by||[];list[idx].status='cancelled';currentReserveProduct.stock+=list[idx].qty;await supabase.from('products').update({reserved_by:list,stock:currentReserveProduct.stock}).eq('id',currentReserveProduct.id);renderReserve();loadProducts()};
addReserveBtn.onclick=async()=>{if(!currentReserveProduct)return;const qty=+qtyInput.value||0;if(qty<=0||qty>currentReserveProduct.stock)return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');const entry={staff:staffInput.value,qty,branch:currentReserveProduct.branch_address,status:'active',at:new Date().toISOString()};const list=currentReserveProduct.reserved_by||[];list.push(entry);await supabase.from('products').update({reserved_by:list,stock:currentReserveProduct.stock-qty}).eq('id',currentReserveProduct.id);staffInput.value='';qtyInput.value='';renderReserve();loadProducts()};
closeModalBtn.onclick=()=>modal.style.display='none';window.viewCancelHistory=async id=>{
  const {data}=await supabase.from('products').select('*').eq('id',id).single();
  const cancelled=(data.reserved_by||[]).filter(r=>r.status==='cancelled');
  let html='<h3>üìï ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>';
  if(!cancelled.length){html+='<p style="font-size:13px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</p>'}
  cancelled.forEach(r=>{html+=`<div class="reserve-row"><span>${r.staff} (${r.qty}) - ${new Date(r.at||'').toLocaleString()}</span></div>`});
  const wrap=document.createElement('div');
  wrap.className='modal-backdrop';
  wrap.style.display='flex';
  wrap.innerHTML=`<div class="modal" style="width:420px">${html}<div style="text-align:right;margin-top:10px"><button class="btn btn-delete">‡∏õ‡∏¥‡∏î</button></div></div>`;
  wrap.querySelector('button').onclick=()=>wrap.remove();
  document.body.appendChild(wrap);
};pm_cancel.onclick=()=>productModal.style.display='none';loadProducts();
</script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseAuth = createClient('https://dfeaeyywbaywrvnudgvu.supabase.co','sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd');

const loginPage = document.getElementById('loginPage');
const loginBtn = document.getElementById('loginBtn');
const loginErr = document.getElementById('loginErr');

// üîê Auth Guard
// üîê Auth Guard + Logout
supabaseAuth.auth.onAuthStateChange((_event, session)=>{
  if(session){
    loginPage.style.display='none';
  }else{
    loginPage.style.display='flex';
  }
});

// üîì Logout
const logoutBtn = document.getElementById('logoutBtn');
if(logoutBtn){
  logoutBtn.onclick = async ()=>{
    await supabaseAuth.auth.signOut();
    location.reload();
  };
}

loginBtn.onclick = async () => {
  loginErr.style.display='none';
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value;
  if(!email || !password){
    loginErr.innerText='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡πÅ‡∏•‡∏∞ Password';
    loginErr.style.display='block';
    return;
  }
  const { error } = await supabaseAuth.auth.signInWithPassword({ email, password });
  if(error){
    loginErr.innerText = error.message;
    loginErr.style.display='block';
  }
};
</script>



</body>
</html>


</div>

<div id="orderSection" class="section">
  <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>Admin Pro | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root{--primary:#2563eb;--success:#16a34a;--warning:#f59e0b;--danger:#dc2626;--bg:#f8fafc;--card:#fff;--text:#1e293b}
        *{box-sizing:border-box; font-family: 'Segoe UI', Tahoma, sans-serif;}
        body{background:var(--bg);color:var(--text);margin:0;padding:20px}
        
        .container{max-width:100%;margin:auto}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:15px;flex-wrap:wrap}
        
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05);border-left:4px solid var(--primary)}

        .table-wrap{background:var(--card);border-radius:14px;box-shadow:0 10px 25px -5px rgba(0,0,0,0.08);overflow-x:auto}
        table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;min-width:1200px}
        th,td{padding:12px 14px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top}
        th{background:#f8fafc;font-weight:600;color:#475569;position:sticky;top:0;z-index:10}
        
        /* Status Tags */
        .status{padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700;display:inline-flex;align-items:center;gap:4px}
        .pending{background:#fef3c7;color:#92400e}
        .paid{background:#dcfce7;color:#166534}
        .rejected{background:#fee2e2;color:#991b1b}
        .shipped{background:#e0f2fe;color:#0369a1}
        .delivered{background:#dcfce7;color:#15803d}
        .cancelled{background:#f1f5f9;color:#64748b}

        .btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s ease;display:inline-flex;align-items:center;gap:6px;justify-content:center;white-space:nowrap}
        .btn:hover{opacity:0.85;transform:translateY(-1px)}
        .btn.primary{background:var(--primary);color:#fff}
        .btn.success{background:var(--success);color:#fff}
        .btn.danger{background:var(--danger);color:#fff}
        .btn.warning{background:var(--warning);color:#fff}
        .btn.outline{background:transparent;border:1px solid #cbd5e1;color:#64748b}
        .btn.outline-danger{background:transparent;border:1px solid var(--danger);color:var(--danger)}

        input.track, input.search{padding:10px 14px;border-radius:10px;border:1px solid #cbd5e1;transition:0.15s ease}
        input.search{width:100%;max-width:400px}
        
        .item-list{background:#f8fafc;padding:20px;border-radius:8px;margin:10px;border:1px dashed #cbd5e1}
        #slipModal{position:fixed;inset:0;background:rgba(15,23,42,0.8);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
    </style>
</head>
<body>

<div id="slipModal" onclick="this.style.display='none'">
    <div style="background:#fff;border-radius:16px;max-width:450px;width:90%;padding:15px;position:relative" onclick="event.stopPropagation()">
        <img id="slipImage" src="" style="width:100%;border-radius:10px" />
        <div style="display:flex;gap:10px;margin-top:15px">
            <button onclick="document.getElementById('slipModal').style.display='none'" class="btn outline" style="flex:1">‡∏õ‡∏¥‡∏î</button>
            <a id="downloadSlip" href="#" download class="btn primary" style="flex:1;text-decoration:none">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</a>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0;font-size:24px">üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Admin)</h1>
            <p style="margin:5px 0 0;color:#64748b" id="orderCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
        <div style="display:flex;gap:10px;flex:1;justify-content:flex-end">
            <input id="searchInput" class="search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå..." />
            <button onclick="loadOrders()" class="btn outline">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
    </div>

    <div class="stats-grid" id="statsBoard"></div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                  <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• (inbound_bill)</th>
                  <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Order ID)</th>
                  <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                  <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                  <th>‡∏¢‡∏≠‡∏î</th>
                  <th>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                  <th>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô / ‡∏™‡∏•‡∏¥‡∏õ</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                  <th>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                </tr>
            </thead>
            <tbody id="orderTable">
                <tr><td colspan="13" style="text-align:center;padding:50px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://dfeaeyywbaywrvnudgvu.supabase.co';
const SUPABASE_KEY = 'sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd'; 
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// üî¥ Supabase Realtime: ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
const realtimeChannel = sb.channel('orders-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
    console.log('Realtime orders update:', payload);
    loadOrders();
  })
  .subscribe();

let ALL_ORDERS = [];
const statusMap = { 'paid': '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', 'rejected': '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', 'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' };

async function loadOrders() {
    try {
        const { data, error } = await sb
            .from('orders')
            .select(`*, order_items(*, products(inbound_bill))`)
            .order('created_at', { ascending: false });

        if(error) throw error;
        ALL_ORDERS = data || [];
        updateStats();
        render(ALL_ORDERS);
    } catch (err) {
        Swal.fire('Error', err.message, 'error');
    }
}

function updateStats() {
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏•‡∏¥‡∏õ / ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    const slipApproved = ALL_ORDERS.filter(o => o.payment_status === 'paid').length;
    const slipRejected = ALL_ORDERS.filter(o => o.payment_status === 'rejected').length;

    // ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å status ‡∏à‡∏£‡∏¥‡∏á)
    const delivering = ALL_ORDERS.filter(o => o.status === 'shipped').length;
    const deliveredSuccess = ALL_ORDERS.filter(o => o.status === 'delivered').length;
    const deliveredFailed = ALL_ORDERS.filter(o => o.status === 'cancelled').length;

    document.getElementById('orderCount').innerText = `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${ALL_ORDERS.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    document.getElementById('statsBoard').innerHTML = `
        <div class="stat-card" style="border-left-color:var(--success)">
            <b>‚úÖ ‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</b>
            <div class="stat-number success">${slipApproved}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--danger)">
            <b>‚ùå ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</b>
            <div class="stat-number danger">${slipRejected}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--primary)">
            <b>üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</b>
            <div class="stat-number primary">${delivering}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--success)">
            <b>üì¶ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b>
            <div class="stat-number success">${deliveredSuccess}</div>
        </div>
        <div class="stat-card" style="border-left-color:var(--danger)">
            <b>üìõ ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b>
            <div class="stat-number danger">${deliveredFailed}</div>
        </div>
    `;
}

function render(list) {
    const tb = document.getElementById('orderTable');
    tb.innerHTML = list.length ? '' : '<tr><td colspan="13" style="text-align:center;padding:40px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</td></tr>';

    list.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><b>${o.order_items?.[0]?.products?.inbound_bill || '-'}</b></td>
            <td><small>${o.id}</small></td>
            <td>
                ${o.customer_name}
            </td>
            <td>
                <small>${o.customer_address || '-'}</small>
            </td>
            <td>
                ${o.customer_phone || '-'}
            </td>
            <td style="font-weight:600">‡∏ø${Number(o.total_amount).toLocaleString()}</td>
            <td>
                <span class="status ${o.payment_status}">
                    ${o.delivery_type === 'pickup' ? 'üè™ ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö' : (statusMap[o.payment_status] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞')}
                </span>
            </td>
            <td>
                ${o.delivery_type === 'delivery' && o.slip_url ? `
                    <button class=\"btn outline btn-slip\" data-url=\"${o.slip_url}\">üßæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ</button>
                    ${o.payment_status === 'pending' ? `
                        <div style=\"margin-top:6px;display:flex;gap:6px\">
                            <button class=\"btn success btn-approve\" data-id=\"${o.id}\">‚úî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button class=\"btn danger btn-reject\" data-id=\"${o.id}\">‚úñ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </div>
                    ` : ''}
                ` : '-'}
            </td>
            <td>
                ${o.status === 'delivered'
                    ? '<span class="status delivered">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>'
                    : o.status === 'cancelled'
                        ? '<span class="status cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>'
                        : o.status === 'shipped'
                            ? '<span class="status shipped">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>'
                            : '<span class="status pending">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>'}
            </td>
            <td>${o.tracking_no || '-'}</td>
            <td>${renderActionButtons(o)}</td>
            <td><small>${new Date(o.created_at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}</small></td>
            <td><button class="btn outline btn-items" data-id="${o.id}">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
        `;
        tb.appendChild(tr);

        const itemRow = document.createElement('tr');
        itemRow.id = `items-${o.id}`;
        itemRow.style.display = 'none';
        itemRow.innerHTML = `<td colspan="13"><div class="item-list" id="box-${o.id}"></div></td>`;
        tb.appendChild(itemRow);
    });
    bindActions();
}

function renderActionButtons(o) {
    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    if (o.status === 'cancelled') return '<span style="color:gray">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>';

    // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    if (o.status === 'delivered') return '<span class="status delivered">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';

    // üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á + ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß + ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
    if (o.delivery_type === 'delivery' && o.payment_status === 'paid' && o.status === 'pending') {
        return `
            <div style="display:flex; gap:5px; flex-wrap:wrap">
                <button class="btn primary" onclick="promptTracking('${o.id}')">üöö ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
                <button class="btn danger" onclick="handleCancel('${o.id}')">üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å & ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
            </div>
        `;
    }

    // üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á + ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    if (o.delivery_type === 'delivery' && o.status === 'shipped') {
        return `
            <div style="display:flex; gap:5px; flex-wrap:wrap">
                <button class="btn success" onclick="updateOrder('${o.id}', {status:'delivered'})">üì¶ ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</button>
                <button class="btn danger" onclick="handleCancel('${o.id}')">‚Ü©Ô∏è ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö / ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
            </div>
        `;
    }

    // üè™ ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö (pickup) ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ
    if (o.delivery_type === 'pickup' && o.status === 'pending') {
        return `
            <div style="display:flex; gap:5px; flex-wrap:wrap">
                <button class="btn success" onclick="updateOrder('${o.id}', {status:'delivered'})">‚úÖ ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>
                <button class="btn warning" onclick="handleCancel('${o.id}')">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö / ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
            </div>
        `;
    }

    // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    return '<small style="color:#94a3b8">-</small>';
}

function bindActions() {
    document.querySelectorAll('.btn-slip').forEach(b => b.onclick = () => openSlip(b.dataset.url));
    document.querySelectorAll('.btn-items').forEach(b => b.onclick = () => toggleItems(b.dataset.id));
    
    document.querySelectorAll('.btn-approve').forEach(b => b.onclick = () => updateOrder(b.dataset.id, {payment_status:'paid'}));
    document.querySelectorAll('.btn-reject').forEach(b => b.onclick = () => handleReject(b.dataset.id));

    document.querySelectorAll('.btn-save').forEach(b => b.onclick = () => {
        const track = document.getElementById(`track-${b.dataset.id}`).value;
        if(!track) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏', 'warning');
        updateOrder(b.dataset.id, { tracking_no: track, status: 'shipped' });
    });

    document.querySelectorAll('.btn-delivered, .btn-pickup-ok').forEach(b => b.onclick = () => updateOrder(b.dataset.id, {status:'delivered'}));

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô shipped)
    document.querySelectorAll('.btn-return').forEach(b => b.onclick = async () => {
        const res = await Swal.fire({
            title: '‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?',
            text: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Cancelled ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö'
        });
        if(res.isConfirmed) updateOrder(b.dataset.id, {status: 'cancelled', tracking_no: null});
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
    document.querySelectorAll('.btn-cancel').forEach(b => b.onclick = async () => {
        const res = await Swal.fire({
            title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå?',
            text: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Cancelled",
            icon: 'error',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
        });
        if(res.isConfirmed) updateOrder(b.dataset.id, {status: 'cancelled'});
    });
}

async function promptTracking(orderId) {
    const { value: tracking } = await Swal.fire({
        title: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏',
        input: 'text',
        inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô TH123456789',
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
        inputValidator: (value) => {
            if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏';
        }
    });

    if (tracking) {
        updateOrder(orderId, { tracking_no: tracking, status: 'shipped' });
    }
}

async function updateOrder(id, payload) {
    const { error } = await sb.from('orders').update(payload).eq('id', id);
    if(error) return Swal.fire('Error', error.message, 'error');
    Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', timer: 800, showConfirmButton: false });
}

// ‚úÖ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏•‡∏¥‡∏õ ‚Üí ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå + ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
async function handleReject(orderId) {
    const res = await Swal.fire({
        title: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
    });
    if (!res.isConfirmed) return;
    await handleCancel(orderId);
}

// ‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå + ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
async function handleCancel(orderId) {
    const res = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?',
        text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'
    });
    if (!res.isConfirmed) return;

    try {
        const order = ALL_ORDERS.find(o => o.id === orderId);
        const items = order.order_items || [];

        for (const item of items) {
            const { data: p } = await sb.from('products').select('stock').eq('id', item.product_id).single();
            if (p) {
                const newStock = (p.stock || 0) + (item.qty || 0);
                await sb.from('products').update({ stock: newStock }).eq('id', item.product_id);
            }
        }

        await sb.from('orders').update({ status: 'cancelled', payment_status: 'rejected' }).eq('id', orderId);
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } catch (err) {
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
    }
}

function toggleItems(id) {
    const row = document.getElementById(`items-${id}`);
    const box = document.getElementById(`box-${id}`);
    if(row.style.display === 'table-row') { row.style.display = 'none'; return; }
    
    row.style.display = 'table-row';
    const order = ALL_ORDERS.find(o => o.id === id);
    box.innerHTML = `
        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:20px">
            <div>
                <strong>üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong><br/>
                <p style="margin:5px 0 15px; color:#475569">${order.customer_address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <strong>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong><br/>
                <table style="min-width:400px; margin-top:10px; background:white; border-radius:8px; border:1px solid #eee">
                    <tr style="background:#f8fafc"><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr>
                    ${(order.order_items || []).map(i => `<tr><td>${i.product_name}</td><td>${i.qty}</td><td>‡∏ø${i.price}</td></tr>`).join('')}
                </table>
            </div>
            <div style="text-align:right">
                <small>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(order.created_at).toLocaleString('th-TH')}</small>
            </div>
        </div>
    `;
}

function openSlip(url) {
    document.getElementById('slipImage').src = url;
    document.getElementById('downloadSlip').href = url;
    document.getElementById('slipModal').style.display = 'flex';
}

document.getElementById('searchInput').oninput = (e) => {
    const q = e.target.value.toLowerCase().trim();
    const filtered = ALL_ORDERS.filter(o => 
        o.customer_name?.toLowerCase().includes(q) || 
        o.customer_phone?.includes(q) ||
        o.id.toLowerCase().includes(q)
    );
    render(filtered);
};

loadOrders();
</script>
</body>
</html>
‡∏´‡∏Å‡∏î‡∏Å‡∏´‡∏î‡∏Å‡∏´‡∏î‡∏´‡∏Å‡∏î‡∏Å‡∏´‡∏î

</div>

<script>
const tabStock = document.getElementById('tabStock');
const tabOrders = document.getElementById('tabOrders');
const stockSection = document.getElementById('stockSection');
const orderSection = document.getElementById('orderSection');

function activate(tab){
  tabStock.classList.remove('active');
  tabOrders.classList.remove('active');
  stockSection.classList.remove('active');
  orderSection.classList.remove('active');

  if(tab==='stock'){
    tabStock.classList.add('active');
    stockSection.classList.add('active');
  }else{
    tabOrders.classList.add('active');
    orderSection.classList.add('active');
  }
}

tabStock.onclick=()=>activate('stock');
tabOrders.onclick=()=>activate('orders');
</script>

</body>
</html>

 


